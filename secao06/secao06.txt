Seção 6: Técnicas avançadas de desenvolvimento

37. O que vamos aprender nesta seção?

38. Introdução a Middlewares

Middlewares

Middlewares são software que são executados encadeados um no outro num Pipeline.

A finalidade deles é tratar uma request HTTP.

Cada Middleware é inserido num determinado ponto da cadeia para executar uma tarefa e passar o controle ao seguinte membro da cadeia.

Cada Middleware pode tratar a request tanto na ida da chamada, quanto da volta na resposta.

Cada Middleware pode num dado momento cortar a cadeia de chamadas e retornar ao cliente. Este procedimento é chamado Short Circuit.


Esquema de como funcionam os Middlewares

Request > Middleware > Response


Middlewares são usados pelo próprio ASP.Net para configurar a aplicação.

Cada Middleware adiciona uma peça de funcionalidade na cadeia de chamadas até chegar ao controller.


Middlewares

A ordem em que os Middlewares são chamados é bem importante. Se não estiver na ordem certa podem causar exceções na Pipeline.



Folder Middlewares > FriendListMiddleware.cs



39. Introdução à injeção de dependência


Injeção de dependência

É um padrão de projeto que nos permite reduzir o acoplamento entre diferentes módulos de uma aplicação.

Acoplamento se refere a quando temos uma classe que precisa usar recursos de outra.

Ou seja, que tem dependência.

A injeção de dependência nos permite:

- Facilidade de manutenção do código
- Código testável (testes unitários)
- Facilidade na reutilização de código


Na prática a DI (injeção de dependência) é alcançada com um Container onde se encontram todas as configurações.

A partir das configurações o Container sabe qual é a classe concreta que ele deve criar e injetar.

A responsabilidade de criar instancias das classes dependentes fica agora por conta do Container e não mais do desenvolvedor.

Com isto evitamos a criação de instancias com o uso sistemático da palavra New.


Formas de Injeção de dependência

Podemos injetar uma dependência das seguintes formas:
- Construtor
- Propriedades

É recomendado sempre usar o Construtor da classe para realizar a injeção de dependência.


Como se faz isto?

Precisamos de uma classe e a sua interface.

Precisamos configurar o Container.

Por ultimo, injetar a dependência.


Precisamos configurar o Container.

public void ConfigureServices(IServiceCollection services){
services.AddSingleton<ICliente, Cliente>();
services.AddScoped<IFornecedorScoped, FornecedorScoped>();
services.AddTransient<IProdutoTransient, ProdutoTransient>();
}

AddSingleton. Garante apenas uma única instância da classe durante o ciclo de vida da aplicação.
AddScoped. Garante apenas uma única instância da classe, porém, durante apenas o ciclo de uma requisição.
AddTransient. Será gerado uma nova instância da classe para cada solicitação de injeção.


Por ultimo, injetar a dependência.


public class HomeController : Controller{

	private readonly ICliente _cliente;
	private readonly IFornecedor _fornecedor;
	private readonly IProduto _produto;

public HomeController(
	ICliente cliente,
	IFornecedor fornecedor,
	IProduto produto,
){
	_cliente = cliente;
	_fornecedor = fornecedor;
	_produto = produto;
}

public IActionResult Index(){
	var clienteModel = _cliente.GetById(1);
	var fornecedorModel = _fornecedor.GetById(1);
	var produtoModel = _produto.GetById(1);
	return View();
}

}




40. Introdução ao Identity. Adicionando segurança à aplicações Web.


Segurança com .Net Core Identity

É uma API do .Net Core que nos permite adicionar funcionalidade de segurança à nossa aplicação.
Suporta interfaces e funcionalidades de login.

Fornece também todo o código e funcionalidades para administrar usuários, senhas, confirmação de email, roles, etc.

Quer dizer que Identity encapsula para nos todo o que precisamos para adicionar segurança as nossas aplicações.

Todo está feito já. Apenas precisamos integrar isso no código.

Segurança com .Net Core Identity

- Inclui uma estrutura para guardar dados num banco de dados.
- Suporte login com fornecedores de identidade externos como Facebook, Google, Twitter, etc
- É uma solução completa.


Como se faz isto?

- Criar uma aplicação web e escolher tipo de autenticação, “Individual user accounts”
- O Visual Studio vai criar automaticamente uma partial view de login.
- Vai ser adicionado também referencias para acesso a banco de dados SqlServer.
- Mais para frente no curso vou explicar como configurar e colocar para funcionar.


Mais conceitos

Temos dois conceitos a explorar, autenticação e autorização.

Autenticar é identificar quem é você. Assim como você tem um RG e uma certidão de nascimento que me dizem quem você é,
para um sistema também preciso identificar quem esta usando o sistema.

Autorização se refere a segunda parte da segurança que é determinar quais as tuas permissões.

Imagina que você chega num edifício comercial, a primeira coisa é se apresentar na segurança.
Os agentes de segurança vão pedir teu RG, te identificar, te registrar e depois vão ligar para o local onde você se dirige.
Se você foi identificado, o seguinte passo é te dar um cartão de acesso (autorização) que vai te permitir entrar e acessar certos locais.
Identity funciona exatamente igual.
Sem autenticação não existe autorização.

Autenticação e autorização no Startup.cs

Autorização é determinada pelo perfil do usuário.

Podemos controlar isso de duas formas numa aplicação ASP.Net Core.
- Usando Roles
- Usando Claims.

Roles e Claims

Um Role é uma string que determina o perfil de um usuário. Assim você poderia definir que a aplicação terá apenas três perfis, Admin, Usuário, Cliente.
Uma vez o usuário fez login no sistema, poderíamos dar acesso a ele somente a certos lugares do sistema.
Para isso usamos um atributo no Controller ou na Action na qual queremos restringir o acesso para esse perfil.

No final das contas, todos usam Policy.


Roles e Claims

Mas as vezes precisamos de informação mais detalhada. Por exemplo, podemos ter acesso a tela de vendas mas não podemos dar descontos.

Nesse caso podemos usar Claims. Uma Claims é uma afirmação e se representa por um par Key, Value.

Key = DarDesconto
Value = false



41. Introdução ao conceito de aplicação em camadas


ASP.Net MVC e o desenvolvimento em camadas

Quando desenvolvemos aplicações, a arquitetura da solução deve ser simples, clara, eficiente, rápida e ser fácil de manter e de alterar.
Se toda vez que o cliente pedir uma alteração na aplicação (e isso acontece o tempo todo) você chega a conclusão que é difícil alterar, então há algo errado no design da
solução.

Se pelo contrário a alteração for fácil de fazer, naturalmente a solução foi bem desenhada.

Do anterior podemos dizer que o melhor design é o que é mais fácil de alterar (estender). Ou pelo menos, é uma das coisas desejadas num bom design.
Que seja uma solução simples.

Como vimos, o MVC já é uma solução com divisão clara de funcionalidade. Você sabe quem é o Controller e para que ele serve, e assim uma View e um Model.
Com cada um servindo a um proposito, é uma boa prática não misturar as coisas, por exemplo, colocando código de acesso a dados na Controller, já que o acesso a dados
é responsabilidade da Model.


Desenvolver em camadas é exatamente isso, separar as partes da solução de software em módulos ou camadas perfeitamente identificáveis e que servem a um
proposito claro.

Não existe um número preciso de camadas que uma aplicação deve ter. O número de camadas da tua aplicação vai responder ao problema que você tem que
resolver.

Aplicações simples tem pelo menos três camadas.

- Camada de Apresentação, onde os dados são apresentados ao usuário por meio de Views.
- Camada de Lógica de Negócios, onde as regras da aplicação são aplicadas as ações e aos dados.
- Camada de Acesso aos Dados, onde os dados são guardados numa base de dados ou outro meio e onde você vai buscar dados para mostrar para o usuário.

Aplicações complexas podem ter um número bem alto de camadas.

O intuito aqui não é entrar na complexidade do modelo anterior e sim dar uma guia de como desenhar uma aplicação simples e organizada.
O modelo anterior responde a um problema de um grande negocio de grande porte e NÃO se aplica a todos os casos.
A sabedoria consiste em identificar qual é o modelo que melhor se adapta ao problema informático que você esta resolvendo.

Como organizar camadas na nossa aplicação?

Podemos usar pastas ou projetos.

Ou os dois!



42. Recapitulando


